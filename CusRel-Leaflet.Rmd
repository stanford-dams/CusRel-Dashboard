---
title: "CusRel-Leaflet"
output: html_document
---

```{r}
library(leaflet)
library(tidyverse)
```

```{r}
# Read in data
cus_rel_data <- read_csv("cus_rel_data1.csv")
```

```{r}
# Add Resolve Time, Incident + Receive Date; Create Label for Popup
cus_rel_data <- cus_rel_data %>% 
  mutate(ResolveTime = round(as.numeric(difftime(as.POSIXct(ResolvedDateTime), as.POSIXct(ReceivedDateTime), units = "days"))), 
         ReceivedDate = as.Date(ReceivedDateTime, "%m/%d/%y", tz="PST8PDT"), 
         IncidentDate = as.Date(IncidentDateTime, "%m/%d/%y", tz="PST8PDT")) %>% 
  mutate(Label = str_c("<b>Received Date:</b> ", ReceivedDate, "<br/>",
                       "<b>Incident Date:</b> ", IncidentDate, "<br/>",
                       "<b>Location:</b> ", Location, "<br/>", 
                       "<b>Destination:</b> ", Destination , "<br/>",
                       "<b>Route:</b> ", Route, " &nbsp;&nbsp ", "<b>Vehicle #:</b> ", VehNo, "<br/>", 
                       "<b>Resolve Time:</b> ", ResolveTime, " day(s)<br/>", 
                       "<b>Reason(s):</b> ", Reason1, "&nbsp", Reason2,
                       "<b>Ticket Number:</b> ", FileNum, "<br/>" 
                       )) # Add a Label for Popup
```

```{r}
# Palette
contact_sources <- unique(cus_rel_data$ContactSource) # get unique contact sources
contact_source_palette <- colorFactor(palette="Set3", domain=contact_sources)
color_list <- contact_source_palette(contact_sources)
```

```{r}
website_routes <- rgdal::readOGR("/Users/kristiepark/Downloads/Spring21RouteShape_MidSignup (2).json")
website_stops <- rgdal::readOGR("/Users/kristiepark/Downloads/UniqueStops_Spring21_MS (1).json")
```

```{r}
library(RColorBrewer)
website_route_palette <- brewer.pal(4, "Set2")
website_route_palette <- colorRampPalette(website_route_palette)(200)
```


```{r}
the_map <- cus_rel_data %>%
  leaflet() %>%
    addProviderTiles(providers$Stamen.TonerLite) %>%
    addCircleMarkers(lat = ~Latitude, lng = ~Longitude, 
                     fill = TRUE, fillColor = ~contact_source_palette(ContactSource), 
                     fillOpacity = 0.6, stroke = FALSE, 
                     color = ~contact_source_palette(ContactSource), 
                     popup = ~Label) %>%
   addLegend("bottomright", colors = color_list, labels = contact_sources, title = "Contact Source") %>% 
 #  addPolylines(data = website_routes, label = website_routes$PUB_RTE, group = "Show Routes", color = website_route_palette) %>% 
   addCircleMarkers(data = website_stops, label = website_stops$STP_DESCRI, group = "Show Stops", color = "black", radius = 0.05)  

the_map
```

