---
title: "Clean-Data.Rmd"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
WORKING_DIR <- "/Users/harrisonli/Documents/iCloud_Documents/Stanford/DAMS/AC_Transit/CusRel-Dashboard"
```


```{r}
raw_data <- read_csv("CusRel-Data.csv")
raw_stops <- read_csv("AC_transit_all_stops.csv")
```

```{r}
# Change StopID in stops data to character, remove irrelevant columns
stops <- raw_stops %>%
  dplyr::select(StopId, Latitude, Longitude) %>%
  mutate(StopId = as.character(StopId))
```


```{r}
# Add lat/lon columns
cleaned_data <- raw_data %>% 
  dplyr::filter(across(Location, ~grepl(pattern=".*\\(\\d\\d\\d\\d\\d\\)$",.))) %>%
  mutate(StopId=substr(Location, nchar(Location)-5, nchar(Location)-1)) %>%
  left_join(stops, by="StopId") %>% # add lat lon to table based on stops data
  tidyr::separate(Reasons, into = c("Reason1", "Reason2"), sep = ";", fill = "right", extra = "drop") %>%
  filter(!is.na(Longitude) & !is.na(Latitude))
```

```{r}
# Add Resolve Time, Incident + Receive Date; Create Label for Popup
cleaned_data <- cleaned_data %>% 
  mutate(ResolveTime = round(as.numeric(difftime(as.POSIXct(ResolvedDateTime), as.POSIXct(ReceivedDateTime), units = "days"))), 
         ReceivedDate = as.Date(ReceivedDateTime, "%m/%d/%y", tz="PST8PDT"), 
         IncidentDate = as.Date(IncidentDateTime, "%m/%d/%y", tz="PST8PDT"), 
         Route = toupper(Route)) %>% 
  mutate(Label = str_c("<b>Received Date:</b> ", ReceivedDate, "<br/>",
                       "<b>Incident Date:</b> ", IncidentDate, "<br/>",
                       "<b>Location:</b> ", Location, "<br/>", 
                       "<b>Destination:</b> ", Destination , "<br/>",
                       "<b>Route:</b> ", Route, " &nbsp;&nbsp ", "<b>Vehicle #:</b> ", VehNo, "<br/>", 
                       "<b>Resolve Time:</b> ", ResolveTime, " day(s)<br/>", 
                       "<b>Reason(s):</b> ", Reason1, if_else(is.na(Reason2), "", str_c("; ", Reason2))
                       )) # Add a Label for Popup

```

```{r}
# Write out
write_csv(cleaned_data, paste(WORKING_DIR, "/Clean-CusRel-data.csv", sep=""))
```

